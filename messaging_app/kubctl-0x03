#!/bin/bash
# kubctl-0x03 - Script to apply rolling update for the Django Messaging App

set -e

DEPLOYMENT="django-blue"
SERVICE="django-messaging-service"

echo "ğŸš€ Applying updated deployment (version 2.0)..."
kubectl apply -f messaging_app/blue_deployment.yaml

echo "ğŸ”„ Starting rolling update..."
kubectl rollout status deployment/$DEPLOYMENT

echo "ğŸ“¦ Verifying current pods..."
kubectl get pods -l app=django-messaging-app

# Get service IP to test live responses
SERVICE_IP=$(kubectl get svc $SERVICE -o jsonpath='{.spec.clusterIP}')

if [ -z "$SERVICE_IP" ]; then
  echo "âŒ Could not retrieve the service ClusterIP."
  exit 1
fi

echo "ğŸŒ Service IP: $SERVICE_IP"
echo "âš™ï¸  Testing for downtime during rollout (sending continuous requests)..."

# Send 20 test requests while rollout happens
for i in {1..20}; do
  curl -s -o /dev/null -w "Request $i â†’ HTTP %{http_code}\n" http://$SERVICE_IP:8000/ || echo "âŒ Request $i failed"
  sleep 1
done

echo "âœ… Rolling update completed successfully!"
echo "ğŸ“‹ Final status:"
kubectl get pods -l app=django-messaging-app

